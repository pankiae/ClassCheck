{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 rounded shadow-md">
    <h2 class="text-2xl font-bold mb-6">Invite Teachers</h2>
    
    <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2">
            Enter Emails (comma or newline separated)
        </label>
        <textarea id="rawEmails" rows="4" 
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            placeholder="teacher1@example.com, teacher2@example.com"></textarea>
        <button type="button" onclick="processEmails()" 
            class="mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded">
            Process Emails
        </button>
    </div>

    <form method="post" id="inviteForm" onsubmit="prepare submission()">
        {% csrf_token %}
        {{ form.emails }}

        <div id="emailListContainer" class="mb-6 space-y-2 max-h-96 overflow-y-auto">
            <!-- Dynamic list items will appear here -->
        </div>

        <button type="submit" id="sendInvitesBtn" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Send Invites
        </button>
    </form>
</div>

<script>
    let emailList = [];

    function processEmails() {
        const rawInput = document.getElementById('rawEmails').value;
        if (!rawInput.trim()) return;

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        // Split by comma or newline, handle potential whitespace
        const potentialEmails = rawInput.split(/[\s,]+/).filter(e => e.trim().length > 0);
        
        const validEmails = [];
        const invalidEmails = [];

        potentialEmails.forEach(email => {
            if (emailRegex.test(email)) {
                // Check for duplicates in the existing list
                if (!emailList.includes(email)) {
                    validEmails.push(email);
                }
            } else {
                invalidEmails.push(email);
            }
        });

        // Add valid emails to the main list
        emailList = [...emailList, ...validEmails];

        // Put invalid emails back into the textarea
        const invalidString = invalidEmails.join(', ');
        document.getElementById('rawEmails').value = invalidString;

        renderList();
    }

    function renderList() {
        const container = document.getElementById('emailListContainer');
        const submitBtn = document.getElementById('sendInvitesBtn');
        
        container.innerHTML = '';
        
        // Enable/Disable submit button
        submitBtn.disabled = emailList.length === 0;

        emailList.forEach((email, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded border';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = email;
            input.className = 'flex-grow bg-transparent border-none focus:ring-0 text-gray-700';
            input.onchange = (e) => updateEmail(index, e.target.value);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'text-red-500 hover:text-red-700 font-bold px-2';
            removeBtn.onclick = () => removeEmail(index);

            div.appendChild(input);
            div.appendChild(removeBtn);
            container.appendChild(div);
        });
    }

    function updateEmail(index, value) {
        emailList[index] = value;
    }

    function removeEmail(index) {
        emailList.splice(index, 1);
        renderList();
    }

    document.getElementById('inviteForm').addEventListener('submit', function(e) {
        const cleanList = emailList.filter(e => e.trim().length > 0);
        document.querySelector('input[name="emails"]').value = cleanList.join(',');
    });
</script>
{% endblock %}